import os
import sys
from backtest.simulator import backtrader
from backtest.optimizer import find_best_dev
from backtest.visualizer import generate_plots
import logging
import pyupbit

logging.basicConfig(level=logging.WARNING)
logging.getLogger().setLevel(logging.INFO)
LOG = logging.getLogger(__name__)

if __name__=='__main__':
    dates = [
            # '2024-04-06', '2024-04-07',
            # '2024-04-09', '2024-04-10',
            #'2024-04-11', '2024-04-26',
            '2024-05-03',
            '2024-05-05',
            '2024-05-06',
            '2024-05-10',
            '2024-05-11',
            '2024-05-12',
            '2024-05-13',
            '2024-05-14',
            '2024-05-15'
            ]
    #dev_cut = {'KRW-BTC': 1.383530837053787e-11, 'KRW-ETH': 5.710423289965171e-10, 'KRW-NEO': 4.017266872435219e-08, 'KRW-XRP': 2.247993347502233e-06, 'KRW-ETC': 9.265494415714998e-08, 'KRW-SNT': 0.000418735843020075, 'KRW-WAVES': 3.948337906719763e-07, 'KRW-QTUM': 1.3759551045938023e-06, 'KRW-LSK': 5.071518092798613e-07, 'KRW-ARDR': 0.0001194714294091, 'KRW-ARK': 2.1133586506300245e-05, 'KRW-STORJ': 2.1240479473969825e-05, 'KRW-ADA': 8.045799402156738e-06, 'KRW-SBD': 3.1403026500820024e-06, 'KRW-POWR': 4.360619174637201e-05, 'KRW-BTG': 3.169367189293076e-07, 'KRW-EOS': 1.267811906931905e-05, 'KRW-SC': 0.0006952735597649, 'KRW-POLYX': 6.0801950974360425e-06, 'KRW-ZRX': 2.3319353530770815e-05, 'KRW-LOOM': 7.55541667433713e-05, 'KRW-BCH': 1.0003904006733348e-08, 'KRW-BAT': 5.540369872638811e-05, 'KRW-IOST': 0.002229821696227755, 'KRW-CVC': 4.791912684346188e-05, 'KRW-IQ': 0.00037795656984993, 'KRW-IOTA': 3.858625706840535e-05, 'KRW-HIFI': 1.9816545915343748e-05, 'KRW-GAS': 4.719733311328874e-07, 'KRW-UPP': 0.000190274246234205, 'KRW-KNC': 2.3587212382683373e-05, 'KRW-BSV': 1.0406651498790266e-07, 'KRW-THETA': 2.9500890295753317e-06, 'KRW-MOC': 0.0001218452882608, 'KRW-TFUEL': 4.682270092323803e-05, 'KRW-MANA': 1.897317600224847e-05, 'KRW-ANKR': 6.257232354354238e-05, 'KRW-AERGO': 7.524726859417245e-05, 'KRW-ATOM': 2.5984401053124256e-07, 'KRW-TT': 0.0020304787496475, 'KRW-CRE': 0.0004956343044193, 'KRW-MBL': 0.0023085867915447296, 'KRW-WAXP': 0.0001945759267485, 'KRW-MED': 0.00046400306776326, 'KRW-MLK': 2.2460359516743404e-05, 'KRW-STPT': 0.0004270851819914, 'KRW-ORBS': 0.000138213417699735, 'KRW-VET': 0.0001403733804479, 'KRW-CHZ': 5.206897983665934e-05, 'KRW-STMX': 0.0025883880315437, 'KRW-DKA': 0.0013454813456964, 'KRW-HIVE': 1.842236210351121e-05, 'KRW-LINK': 4.52814173899905e-07, 'KRW-XTZ': 2.2372430268191283e-05, 'KRW-BORA': 4.050294269148704e-05, 'KRW-JST': 0.0003200714970655, 'KRW-CRO': 3.478899385355994e-05, 'KRW-TON': 6.259506938234613e-06, 'KRW-SXP': 4.31627675682916e-05, 'KRW-DOT': 9.114564359093912e-07, 'KRW-MVL': 0.00019282040200814453, 'KRW-AQT': 1.026873606764545e-05, 'KRW-META': 0.000217548525074935, 'KRW-FCT2': 0.0002826293485861, 'KRW-SAND': 1.7304946932831395e-05, 'KRW-HPO': 0.0003446938704996, 'KRW-DOGE': 3.3961477054736855e-06, 'KRW-FLOW': 4.654507873413237e-06, 'KRW-AXS': 2.681748917651781e-06, 'KRW-STX': 6.253335451301081e-07, 'KRW-XEC': 0.1928985349435646, 'KRW-SOL': 4.691123216857668e-09, 'KRW-AAVE': 1.789251120560689e-07, 'KRW-1INCH': 1.20931640071279e-05, 'KRW-ALGO': 3.32794270712187e-05, 'KRW-NEAR': 2.8357701697377653e-07, 'KRW-AVAX': 8.798618050583089e-08, 'KRW-SHIB': 0.026966686118731407, 'KRW-MASK': 5.718218536005195e-06, 'KRW-ARB': 2.5940033140481276e-06, 'KRW-SUI': 3.038117767903283e-06, 'KRW-GRT': 6.495568388744104e-06, 'KRW-BLUR': 6.398255520645579e-06, 'KRW-IMX': 9.774075317584012e-07, 'KRW-SEI': 3.140461176995908e-06, 'KRW-MINA': 3.167472387035781e-05, 'KRW-ID': 8.232341911224056e-06}
    #dev_cut = {'KRW-BTC': 1.8676075103041464e-10, 'KRW-GLM': 5.767264285795995e-05, 'KRW-ETH': 3.2096144610948675e-09, 'KRW-MTL': 9.374124632441e-06, 'KRW-XEM': 0.0008681642683769, 'KRW-LSK': 7.749928271933168e-06, 'KRW-STEEM': 0.0006271310315149, 'KRW-STORJ': 3.388945081117706e-05, 'KRW-ADA': 3.3649442174453224e-05, 'KRW-POWR': 6.7988391237141e-05, 'KRW-BTG': 2.1144173209672362e-07, 'KRW-EOS': 3.15556907988985e-05, 'KRW-SC': 0.0019826631641073, 'KRW-ONT': 4.472224659817241e-05, 'KRW-LOOM': 0.0002244270472308, 'KRW-BCH': 1.3412306228860553e-08, 'KRW-HIFI': 1.3267995384765625e-05, 'KRW-ONG': 4.911211822162517e-05, 'KRW-ELF': 3.464767178430198e-05, 'KRW-KNC': 3.9518187929749626e-05, 'KRW-THETA': 1.2623948240589864e-05, 'KRW-QKC': 0.0049990522581302, 'KRW-MOC': 0.0003074135774294, 'KRW-ANKR': 0.0002105943367505, 'KRW-HBAR': 0.0001439573626826, 'KRW-MLK': 6.134307432118259e-05, 'KRW-STPT': 0.0004438318308202,  'KRW-DKA': 0.001002373008413, 'KRW-HIVE': 3.875236085347862e-05, 'KRW-KAVA': 3.227671259164868e-05, 'KRW-AHT': 0.0171882509934369, 'KRW-LINK': 6.1559806886462e-07, 'KRW-CRO': 0.0001779648817787, 'KRW-SXP': 4.063566767091502e-05, 'KRW-HUNT': 4.497033876713867e-05, 'KRW-DOT': 2.2762178574192684e-06, 'KRW-SAND': 1.70444147748447e-05, 'KRW-PUNDIX': 9.7451673654245e-06, 'KRW-FLOW': 1.2878336750757102e-05, 'KRW-AXS': 2.474640536439949e-06, 'KRW-XEC': 0.2072190704331792, 'KRW-SOL': 3.3099947801338165e-08, 'KRW-AAVE': 3.2347770135234173e-07, 'KRW-ALGO': 6.53036533456064e-05, 'KRW-NEAR': 5.840784263221978e-07, 'KRW-BLUR': 4.130038971873764e-05, 'KRW-ASTR': 0.0003582161060844}
    #dev_cut = {'KRW-BTC': 1.383530837053787e-11, 'KRW-ETC': 9.242330679675711e-08, 'KRW-QTUM': 1.3759551045938023e-06, 'KRW-LSK': 6.040653503344348e-07, 'KRW-ARDR': 0.0001194714294091, 'KRW-ARK': 2.1133586506300245e-05, 'KRW-IQ': 0.0002976407987568199, 'KRW-IOTA': 3.858625706840535e-05, 'KRW-GAS': 4.955719976895319e-07, 'KRW-BSV': 1.0406651498790266e-07, 'KRW-ANKR': 9.079121455337518e-05, 'KRW-AERGO': 7.524726859417245e-05, 'KRW-ATOM': 2.932177256338491e-07, 'KRW-TT': 0.0020304787496475, 'KRW-CRE': 0.0004956343044193, 'KRW-MBL': 0.0023085867915447296, 'KRW-HIVE': 2.167336718060143e-05, 'KRW-AHT': 0.00025217555006905497, 'KRW-BORA': 4.050294269148704e-05, 'KRW-CRO': 3.652844354623794e-05, 'KRW-TON': 6.259506938234613e-06, 'KRW-MVL': 0.0002048716771336536, 'KRW-AQT': 8.779769337836857e-06, 'KRW-FLOW': 4.654507873413237e-06, 'KRW-STX': 3.6933762509246964e-07, 'KRW-SOL': 4.330126625560417e-09, 'KRW-1INCH': 1.20931640071279e-05, 'KRW-ALGO': 3.32794270712187e-05, 'KRW-AVAX': 8.358687148053934e-08, 'KRW-SHIB': 0.028062207742304876, 'KRW-ARB': 2.5940033140481276e-06, 'KRW-GRT': 6.495568388744104e-06, 'KRW-IMX': 1.4216836825576757e-06}
    #dev_cut = {'KRW-ETC': 8.802219694929248e-08, 'KRW-WAVES': 4.145754802055751e-07, 'KRW-XEM': 0.0008247560549580549, 'KRW-LSK': 5.491503184858498e-07, 'KRW-XLM': 9.95061392224698e-05, 'KRW-POWR': 4.360619174637201e-05, 'KRW-SC': 0.000730037237753145, 'KRW-ONT': 4.472224659817241e-05, 'KRW-POLYX': 5.168165832820636e-06, 'KRW-BAT': 5.540369872638811e-05, 'KRW-IQ': 0.0002976407987568199, 'KRW-IOTA': 3.858625706840535e-05, 'KRW-GAS': 4.955719976895319e-07, 'KRW-UPP': 0.000190274246234205, 'KRW-BTT': 1.4624999999999986, 'KRW-ATOM': 2.5497193533378174e-07, 'KRW-TT': 0.0020304787496475, 'KRW-MED': 0.00046400306776326, 'KRW-ORBS': 0.00013130274681474825, 'KRW-KAVA': 3.227671259164868e-05, 'KRW-XTZ': 2.2372430268191283e-05, 'KRW-CRO': 3.652844354623794e-05, 'KRW-SXP': 4.31627675682916e-05, 'KRW-MVL': 0.0002048716771336536, 'KRW-AQT': 9.241862460880903e-06, 'KRW-GLM': 5.767264285795995e-05, 'KRW-META': 0.00022842595132868175, 'KRW-SAND': 1.7304946932831395e-05, 'KRW-FLOW': 4.654507873413237e-06, 'KRW-STX': 3.6933762509246964e-07, 'KRW-SOL': 4.0754132946450986e-09, 'KRW-AAVE': 1.8787136765887234e-07, 'KRW-NEAR': 2.7648759154943206e-07, 'KRW-AVAX': 8.358687148053934e-08, 'KRW-SHIB': 0.02494418465982655, 'KRW-ARB': 2.5940033140481276e-06, 'KRW-GRT': 6.495568388744104e-06, 'KRW-BLUR': 8.637644952871532e-06, 'KRW-SEI': 3.140461176995908e-06}
    #final dev_cut:
    dev_cut = {'KRW-BTC': 1.4527073789064764e-11, 'KRW-ETH': 5.710423289965171e-10, 'KRW-XRP': 2.4846242261866788e-06, 'KRW-ETC': 9.704447213659498e-08, 'KRW-QTUM': 1.3759551045938023e-06, 'KRW-LSK': 6.342686178511566e-07, 'KRW-STEEM': 3.120588330265441e-06, 'KRW-ARK': 2.1133586506300245e-05, 'KRW-STORJ': 2.2302503447668317e-05, 'KRW-ADA': 8.664707048476488e-06, 'KRW-SBD': 3.1403026500820024e-06, 'KRW-ZIL': 0.00021136114666611, 'KRW-LOOM': 8.350723692688408e-05, 'KRW-BCH': 1.0504099207070016e-08, 'KRW-IQ': 0.0003125228386946609, 'KRW-GAS': 4.955719976895319e-07, 'KRW-KNC': 2.4766573001817543e-05, 'KRW-MOC': 0.0001218452882608, 'KRW-MANA': 1.9971764212893128e-05, 'KRW-ANKR': 9.533077528104394e-05, 'KRW-AERGO': 7.524726859417245e-05, 'KRW-ATOM': 3.0787861191554157e-07, 'KRW-TT': 0.0020304787496475, 'KRW-CRE': 0.0004956343044193, 'KRW-WAXP': 0.0001945759267485, 'KRW-MED': 0.00054133691239047, 'KRW-MLK': 2.3583377492580574e-05, 'KRW-VET': 0.000147392049470295, 'KRW-HIVE': 2.167336718060143e-05, 'KRW-LINK': 4.312515941903857e-07, 'KRW-XTZ': 2.354992659809609e-05, 'KRW-CRO': 3.835486572354984e-05, 'KRW-TON': 6.259506938234613e-06, 'KRW-MVL': 0.0002048716771336536, 'KRW-AQT': 9.2187578047287e-06, 'KRW-META': 0.000240448369819665, 'KRW-SAND': 1.8170194279472966e-05, 'KRW-FLOW': 4.654507873413237e-06, 'KRW-AXS': 2.681748917651781e-06, 'KRW-STX': 3.8780450634709314e-07, 'KRW-AAVE': 1.789251120560689e-07, 'KRW-ALGO': 3.494339842477963e-05, 'KRW-NEAR': 2.9775586782246537e-07, 'KRW-AVAX': 8.358687148053934e-08, 'KRW-GMT': 1.0831461432985544e-05, 'KRW-SHIB': 0.02946531812942012, 'KRW-ARB': 2.723703479750534e-06, 'KRW-GRT': 6.82034680818131e-06, 'KRW-BLUR': 7.1091728007173125e-06, 'KRW-IMX': 1.4927678666855595e-06}
    
    coins = list(dev_cut.keys())
    profit_cut = {coin: 1.2 for coin in coins}
    coins = pyupbit.get_tickers(fiat='KRW')
    dict = {'2024-04-11': {'buying_idx': [], 'bought_idx': [], 'selling_idx': [], 'sold_idx': []}}
    sim = backtrader(coins, dates)
    vis = generate_plots()
    
    profits = []
    new_dev_cut = {}
    # for date in dates:
    #     profit, traded_coins = sim.simulate_all(date, dev_cut, profit_cut)
    #     profits.append(profit)
    # LOG.info(f'profits: {profits}')
    coins = pyupbit.get_tickers(fiat='KRW')
    coins.remove('KRW-AKT')
    for coin in coins:
        LOG.info(f'optimizing for {coin}')
        opt = find_best_dev(coins, dates)
        best_dev_cut, best_profit = opt.optimize_dev(coin, dates, dev_cut)
        
        if best_profit > 1.01:
            LOG.info(f'best dev: {best_dev_cut} best profit: {best_profit}')
            new_dev_cut[coin] = float(best_dev_cut[0])

        LOG.info(f'final dev_cut: {new_dev_cut}')